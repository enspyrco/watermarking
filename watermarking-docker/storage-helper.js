// storage-helper.js
// Helper module for Google Cloud Storage operations
// Replaces gsutil command-line calls with @google-cloud/storage SDK

const {Storage} = require('@google-cloud/storage');
const fs = require('fs');
const path = require('path');

// Initialize Storage client with credentials from Firebase Admin
// The service account JSON should have storage permissions
const storage = new Storage({
  keyFilename: '/app/keys/firebase-service-account.json'
});

const BUCKET_NAME = 'watermarking-4a428.firebasestorage.app';

/**
 * Downloads a file from Google Cloud Storage
 * @param {string} gcsPath - Path within the GCS bucket (e.g., 'originals/image.png')
 * @param {string} localPath - Local file system path to save to (e.g., '/tmp/123/image.png')
 * @param {function} callback - Callback function(error)
 */
function downloadFile(gcsPath, localPath, callback) {
  console.log(`Downloading from GCS: gs://${BUCKET_NAME}/${gcsPath} -> ${localPath}`);

  // Ensure directory exists
  const dir = path.dirname(localPath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }

  const bucket = storage.bucket(BUCKET_NAME);
  const file = bucket.file(gcsPath);

  file.download({ destination: localPath })
    .then(() => {
      console.log(`Successfully downloaded to ${localPath}`);
      callback(null);
    })
    .catch((error) => {
      console.error(`Error downloading file: ${error}`);
      callback(error);
    });
}

/**
 * Uploads a file to Google Cloud Storage
 * @param {string} localPath - Local file system path to upload from (e.g., '/tmp/123/image-marked.png')
 * @param {string} gcsPath - Path within the GCS bucket to upload to (e.g., 'marked-images/uid/123/image.png')
 * @param {function} callback - Callback function(error)
 */
function uploadFile(localPath, gcsPath, callback) {
  console.log(`Uploading to GCS: ${localPath} -> gs://${BUCKET_NAME}/${gcsPath}`);

  const bucket = storage.bucket(BUCKET_NAME);

  bucket.upload(localPath, {
    destination: gcsPath,
    metadata: {
      cacheControl: 'public, max-age=31536000',
    }
  })
    .then(() => {
      console.log(`Successfully uploaded to ${gcsPath}`);
      callback(null);
    })
    .catch((error) => {
      console.error(`Error uploading file: ${error}`);
      callback(error);
    });
}

/**
 * Gets the public URL for a file in GCS
 * @param {string} gcsPath - Path within the GCS bucket
 * @returns {string} The public URL for the file
 */
function getPublicUrl(gcsPath) {
  const encodedPath = encodeURIComponent(gcsPath);
  return `https://firebasestorage.googleapis.com/v0/b/${BUCKET_NAME}/o/${encodedPath}?alt=media`;
}

module.exports = {
  downloadFile,
  uploadFile,
  getPublicUrl
};
